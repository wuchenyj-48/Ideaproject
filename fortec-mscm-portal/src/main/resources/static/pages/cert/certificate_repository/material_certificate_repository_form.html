<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>编辑表单</title>
        <style>
            .custom-form .layui-form-label {
                width: 120px
            }

            .custom-form .layui-input-block {
                margin-left: 150px
            }
        </style>
    </head>
    <body>

        <div class="layui-fluid" id="app">

            <form class="layui-form custom-form" id="editForm" lay-filter="editForm">
                <input type="hidden" name="id" class="layui-input"/>
                <input type="hidden" name="catalogId"/>
                <input type="hidden" name="supplierId"/>
                <input type="hidden" name="manufacturerId"/>

                <div class="layui-row layui-col-space5 layui-form-item">
                    <div class="layui-col-xs6">
                        <spen class="layui-form-label">
                            品类
                        </spen>
                        <div class="layui-input-block">
                            <input readonly type="text" name="catalogName" id="catalogName" placeholder="请选择品类"
                                   lay-verify="required"
                                   class="layui-input" lay-filter="tree"/>
                        </div>
                    </div>

                    <div class="layui-col-xs6">
                        <label class="layui-form-label">
                            供应商
                        </label>
                        <div class="layui-input-block">
                            <input readonly type="text" name="supplierName" id="supplierName" placeholder="请选择供应商"
                                   lay-verify="required"
                                   class="layui-input"/>
                        </div>
                    </div>
                </div>


                <div class="layui-row layui-col-space5 layui-form-item">
                    <div class="layui-col-xs6">
                        <label class="layui-form-label">
                            商品类型
                        </label>
                        <div class="layui-input-block">
                            <select disabled name="materialTypeCode">
                                <option value="">请选择商品类型</option>
                            </select>
                        </div>
                    </div>


                    <div class="layui-col-xs6">
                        <label class="layui-form-label">
                            品名
                        </label>
                        <div class="layui-input-block">
                            <input readonly type="text" name="materialName" required lay-verify="required"
                                   placeholder="请输入品名"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>

                </div>

                <div class="layui-row layui-col-space5 layui-form-item">
                    <div class="layui-col-xs6">
                        <label class="layui-form-label">
                            商品名
                        </label>
                        <div class="layui-input-block">
                            <input readonly type="text" name="materialTradeName" required lay-verify="required"
                                   placeholder="请输入商品名"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>


                    <div class="layui-col-xs6">
                        <label class="layui-form-label">
                            ERP代码
                        </label>
                        <div class="layui-input-block">
                            <input readonly type="text" name="materialErpCode" lay-verify="" placeholder="请输入ERP代码"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>

                </div>

                <div class="layui-row layui-col-space5 layui-form-item">
                    <div class="layui-col-xs6">
                        <label class="layui-form-label">
                            助记码
                        </label>
                        <div class="layui-input-block">
                            <input readonly type="text" name="pinyin" lay-verify="" placeholder="请输入助记码"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>


                    <div class="layui-col-xs6">
                        <label class="layui-form-label">
                            注册证号
                        </label>
                        <div class="layui-input-block">
                            <input readonly type="text" name="certificateNo" lay-verify="" placeholder="请输入注册证号"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>

                </div>

                <div class="layui-row layui-col-space5 layui-form-item">
                    <div class="layui-col-xs6">
                        <label class="layui-form-label">
                            注册证效期
                        </label>
                        <div class="layui-input-block">
                            <input readonly type="text" name="certificateExpiredDate" placeholder="请选择注册证效期"
                                   autocomplete="off"
                                   class="layui-input">
                        </div>
                    </div>


                    <div class="layui-col-xs6">
                        <label class="layui-form-label">
                            批准文号
                        </label>
                        <div class="layui-input-block">
                            <input readonly type="text" name="approvalNo" lay-verify="" placeholder="请输入批准文号"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>

                </div>

                <div class="layui-row layui-col-space5 layui-form-item">
                    <div class="layui-col-xs6">
                        <label class="layui-form-label">
                            生产厂商
                        </label>
                        <div class="layui-input-block">
                            <input readonly type="text" name="manufacturerName" id="manufacturerName"
                                   lay-verify="required"
                                   placeholder="请选择生产厂商"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>

                </div>
                <div class="block"></div>
                <div class="layui-row ">
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button class="layui-btn layui-btn-primary form-close" type="button">关闭</button>
                        </div>
                    </div>
                </div>
            </form>


            <div class="layui-tab child-tab">
                <ul class="layui-tab-title">
                    <li class="layui-this">商品资质管理</li>
                </ul>
                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show">
                        <div id="materialSpecToolbar">
                            <button type="button" class="layui-btn layui-btn-sm layui-btn-normal"
                                    lay-event="addNewLine">
                                <i class="layui-icon layui-icon-add-1"></i> 增行
                            </button>
                            <button type="button" class="layui-btn layui-btn-sm layui-btn-normal" lay-event="refresh">
                                <i class="layui-icon layui-icon-refresh"></i> 刷新
                            </button>
                        </div>
                        <div class="row-edit-table" id="material_certificate_repository_table"
                             lay-filter="material_certificate_repository_table"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 子表管理模板 开始  -->
        <script type="text/html" id="businessTypeCodeTpl">
            <select data-name="businessTypeCode" lay-verify="required"
                    value="{{d.businessTypeCode ? d.businessTypeCode : ''}}"
                    lay-filter="businessTypeCode" data-index="{{d.LAY_TABLE_INDEX}}">
                {{# $global.getDictDataList('cert_business_type').forEach(o => { }}
                <option value="{{o.value}}" {{o.value== d.businessTypeCode ?
                'selected' : ''}}>{{o.label}}</option>
                {{# }) }}
            </select>
        </script>
        <script type="text/html" id="certificateNameTpl">
            <input type="text" data-name="certificateName" value="{{d.certificateName ? d.certificateName : ''}}"
                   lay-filter="certificateName"
                   data-index="{{d.LAY_TABLE_INDEX}}" lay-verify="required" placeholder="必填"
                   class="layui-input custom-input"/>
        </script>
        <script type="text/html" id="certificateNoTpl">
            <input type="text" data-name="certificateNo" value="{{d.certificateNo ? d.certificateNo : ''}}"
                   lay-filter="certificateNo"
                   data-index="{{d.LAY_TABLE_INDEX}}" lay-verify=""
                   class="layui-input custom-input"/>
        </script>
        <script type="text/html" id="expiryDateTpl">
            <input type="text" data-name="expiryDate" value="{{d.expiryDate ? d.expiryDate : ''}}"
                   lay-filter="expiryDate"
                   data-index="{{d.LAY_TABLE_INDEX}}" lay-verify=""
                   class="layui-input custom-input"/>
        </script>
        <script type="text/html" id="certificateSignTpl">
            <input type="text" data-name="certificateSign" value="{{d.certificateSign ? d.certificateSign : ''}}"
                   lay-filter="certificateSign"
                   data-index="{{d.LAY_TABLE_INDEX}}" lay-verify=""
                   class="layui-input custom-input"/>
        </script>
        <script type="text/html" id="certificateSignToTpl">
            <input type="text" data-name="certificateSignTo" value="{{d.certificateSignTo ? d.certificateSignTo : ''}}"
                   lay-filter="certificateSignTo"
                   data-index="{{d.LAY_TABLE_INDEX}}" lay-verify=""
                   class="layui-input custom-input"/>
        </script>
        <script type="text/html" id="docIdsTpl">
            <input type="text" data-name="docIds" value="{{d.docIds ? d.docIds : ''}}" lay-filter="docIds"
                   data-index="{{d.LAY_TABLE_INDEX}}" lay-verify="required"
                   class="layui-input custom-input"/>
        </script>

        <script type="text/html" id="cellToolbar">
            {{#  if($strings.isBlank(d.id)){ }}
            <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="newEdit" title="保存"><i
                    class="fas fa-check"></i></a>
            <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="newDel" title="删除"><i
                    class="far fa-trash-alt"></i></a>
            {{#  } else { }}
            <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="edit" title="保存"><i
                    class="fas fa-save"></i></a>
            <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del" title="删除"><i
                    class="far fa-trash-alt"></i></a>
            {{#  } }}
        </script>
        <!-- 子表管理模板 结束  -->

        <script src="/scripts/utils/common.js"></script>
        <script>

            let mainFunction = () => {
                let form = layui.form, $ = layui.$
                var laydate = layui.laydate;

                let model = {}


                window.packUnits = []

                // 加载子表表格
                window.reloadMaterialSpecTable = () => {
                    if ($strings.isBlank(model.id)) {
                        return
                    }
                    $http.get(`/cert/certificate_repositorys/list?targetDescribeId=${model.id}`).then(resp => {
                        layui.table.render({
                            elem: '#material_certificate_repository_table',
                            data: resp.data.data,
                            height: 300,
                            cols: [[ //表头
                                {type: 'numbers', align: 'center', fixed: 'left'},
                                {
                                    field: 'certificateName',
                                    title: '资质名称',
                                    align: 'center',
                                    templet: "#certificateNameTpl"
                                },
                                {field: 'certificateNo', title: '资质编号', align: 'center', templet: "#certificateNoTpl"},
                                {field: 'expiryDate', title: '有效期', align: 'center', templet: "#expiryDateTpl"},
                                {
                                    field: 'certificateSign',
                                    title: '签发方',
                                    align: 'center',
                                    templet: "#certificateSignTpl"
                                },
                                {
                                    field: 'certificateSignTo',
                                    title: '签发给',
                                    align: 'center',
                                    templet: "#certificateSignToTpl"
                                },
                                {field: 'docIds', title: '文档IDs', align: 'center', templet: "#docIdsTpl"},
                                {field: 'version', title: '当前版本号', align: 'center'},
                                {
                                    field: "LAY_CELL_TOOLBAR",
                                    title: '操作',
                                    templet: '#cellToolbar',
                                    width: 150,
                                    align: 'center',
                                    fixed: 'right'
                                }
                            ]],
                            done(){
                                renderCertificateName()
                                renderExpiryDate()
                            }
                        });
                        $editable.watch('material_certificate_repository_table')
                    })
                }

                window.initForm = (formData) => {
                    // 必须要重新创建对象，原因未知
                    let data = $.extend({}, formData)
                    form.val("editForm", data)
                    model = data

                    if ($strings.isNotBlank(model.id)) {
                        $(".child-tab").show()
                        window.reloadMaterialSpecTable && window.reloadMaterialSpecTable()
                    }
                }


                /**
                 *  渲染有效期选择框
                 */
                window.renderExpiryDate = () => {
                    let rows = layui.table.getRows('material_certificate_repository_table')
                    for (let i = 0; i < rows.length; i++) {
                        //渲染日期
                        laydate.render({
                            elem: `[data-name='expiryDate'][data-index='${i}']`,
                            type: 'date',
                            trigger: 'click',
                            format : 'yyyy-MM-dd',
                            value: rows[i].expiryDate,
                            min : 0 ,
                            done(value){
                                rows[i].expiryDate = value
                            }
                        });
                    }
                }


                /**
                 *  渲染商品规格选择框
                 */
                window.renderCertificateName = () => {
                    let rows = layui.table.getRows('material_certificate_repository_table')
                    for (let i = 0; i < rows.length; i++) {
                        //渲染规格
                        layui.tableSelect.render({
                            elem: `[data-name='certificateName'][data-index='${i}']`,	//定义输入框input对象 必填
                            checkedKey: 'id', //表格的唯一建值，非常重要，影响到选中状态 必填
                            searchPlaceholder: '关键词搜索',	//搜索输入框的提示文字 默认关键词搜索
                            table: {	//定义表格参数，与LAYUI的TABLE模块一致，只是无需再定义表格elem
                                url: '/cert/certificates/page_by_keywords',
                                cols: [[
                                    {type: 'radio'},
                                    {field: 'name', title: '资质名称'}
                                ]]
                            },
                            done(elem, data) {
                                rows[i].certificateId = data.data.length > 0 ? data.data[0].id : null
                                layui.each(data.data, function (index, item) {
                                    elem.val(item.name)
                                })
                            }

                        })
                    }
                }



                // 渲染下拉框 数据
                $global.getDictDataList('base_material_type').forEach(o => {
                    $("select[name='materialTypeCode']").append("<option value='" + o.value + "'>" + o.label + "</option>")
                })


                /*** 子表管理开始 */
                $("#materialSpecToolbar button[lay-event='addNewLine']").click(() => {
                    layui.table.addRow('material_certificate_repository_table', 0, {
                        inputCodingType: 0
                    })
                    form.render('select')
                })

                $("#materialSpecToolbar button[lay-event='batchSave']").click(() => {
                    $editable.validateAllRows('material_certificate_repository_table', (valid, errors) => {
                        if (!valid) {
                            return
                        }
                        let rows = layui.table.getRows('material_certificate_repository_table')
                        rows.forEach(o => o.materialId = model.id)
                        $http.put("/cert/certificate_repositorys/batch_save", rows).then(resp => {
                            if (resp.data.success) {
                                layui.layer.msg(resp.data.msg, {icon: 1})
                                window.reloadMaterialSpecTable()
                            } else {
                                layui.layer.msg(resp.data.msg, {icon: 5})
                            }
                        })
                    })
                })

                $("#materialSpecToolbar button[lay-event='refresh']").click(() => {
                    window.reloadMaterialSpecTable()
                })

                // 监听子表的列工具栏
                layui.table.on('tool(material_certificate_repository_table)', function (obj) {
                    // 获取行索引
                    let index = obj.tr[0].getAttribute("data-index")
                    var data = obj.data;
                    if (obj.event === 'newDel') {
                        // 未在数据库中存在，直接从界面移除即可
                        obj.del()
                        return
                    }
                    if (obj.event === 'del') {
                        layer.confirm('真的删除行么', function (index) {
                            $http.delete(`/cert/certificate_repositorys/` + data.id).then(resp => {
                                layer.msg(resp.data.msg, {icon: 1})
                                obj.del()
                            })
                        });
                        return
                    }

                    // 校验并保存
                    $editable.validateSingleRow("material_certificate_repository_table", index, (valid, error) => {
                        if (!valid) {
                            return
                        }
                        let data = layui.table.cache.material_certificate_repository_table[index]
                        data.targetDescribeId = model.id
                        let promise = $http.post("/cert/certificate_repositorys/save_for_material", data)

                        promise.then(resp => {
                            if (resp.data.success) {
                                layer.msg(resp.data.msg, {icon: 1})

                                // 重新渲染单行数据
                                layui.table.renderSpecRow('material_certificate_repository_table', index, {
                                    id: resp.data.data.id,
                                    version: 1
                                })
                            } else {
                                layer.msg(resp.data.msg, {icon: 5})
                            }
                        })
                    })
                });


                /*** 子表管理结束 */

                $(".form-close").click(() => {
                    var index = parent.layer.getFrameIndex(window.name);
                    parent.layer.close(index);
                })


            }

            extendParentScriptsAndStyles(() => {
                loadAllJs(["/scripts/utils/editable.js", "/lib/treeSelect.js", "/lib/tableSelect.js"], mainFunction)
            })

        </script>

    </body>
</html>
    
    