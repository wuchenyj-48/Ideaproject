<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>编辑表单</title>
        <style>
            .custom-form .layui-form-label {
                width: 120px
            }

            .custom-form .layui-input-block {
                margin-left: 150px
            }
        </style>
    </head>
    <body>

        <div class="layui-fluid" id="app">

            <form class="layui-form custom-form" id="editForm" lay-filter="editForm">
                <input type="hidden" name="id" class="layui-input"/>
                <input type="hidden" name="catalogId"/>
                <input type="hidden" name="manufacturerId"/>

                <div class="layui-row layui-col-space5 layui-form-item">
                    <div class="layui-col-xs4">
                        <spen class="layui-form-label">
                            <span class="required-star">*</span>品类
                        </spen>
                        <div class="layui-input-block">
                            <input type="text" name="catalogName" id="catalogName" placeholder="请选择品类"
                                   lay-verify="required" autocomplete="off"
                                   class="layui-input" lay-filter="tree"/>
                        </div>
                    </div>

                    <div class="layui-col-xs4">
                        <label class="layui-form-label">
                            <span class="required-star">*</span>生产厂商
                        </label>
                        <div class="layui-input-block">
                            <input type="text" name="manufacturerName" id="manufacturerName" lay-verify="required"
                                   placeholder="请选择生产厂商" readonly
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>

                    <div class="layui-col-xs4">
                        <label class="layui-form-label">
                            <span class="required-star">*</span> 商品类型
                        </label>
                        <div class="layui-input-block">
                            <select id="materialTypeCode" name="materialTypeCode" disabled>
                                <option value="">请选择商品类型</option>
                            </select>
                        </div>
                    </div>

                </div>


                <div class="layui-row layui-col-space5 layui-form-item">

                    <div class="layui-col-xs4">
                        <label class="layui-form-label">
                            <span class="required-star">*</span> 品名
                        </label>
                        <div class="layui-input-block">
                            <input type="text" name="materialName" required lay-verify="required" placeholder="请输入品名"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>

                    <div class="layui-col-xs4">
                        <label class="layui-form-label">
                            <span class="required-star">*</span> 商品名
                        </label>
                        <div class="layui-input-block">
                            <input type="text" name="materialTradeName" required lay-verify="required"
                                   placeholder="请输入商品名"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>


                    <div class="layui-col-xs4">
                        <label class="layui-form-label">
                            ERP代码
                        </label>
                        <div class="layui-input-block">
                            <input type="text" name="materialErpCode" lay-verify="" placeholder="请输入ERP代码"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>

                </div>

                <div class="layui-row layui-col-space5 layui-form-item">
                    <div class="layui-col-xs4">
                        <label class="layui-form-label">
                            助记码
                        </label>
                        <div class="layui-input-block">
                            <input type="text" name="pinyin" lay-verify="" placeholder="请输入助记码"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>


                    <div class="layui-col-xs4">
                        <label class="layui-form-label">
                            注册证号
                        </label>
                        <div class="layui-input-block">
                            <input type="text" name="certificateNo" lay-verify="" placeholder="请输入注册证号"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>

                    <div class="layui-col-xs4">
                        <label class="layui-form-label">
                            注册证效期
                        </label>
                        <div class="layui-input-block">
                            <input type="text" name="certificateExpiredDate" placeholder="请选择注册证效期" autocomplete="off"
                                   readonly
                                   class="layui-input">
                        </div>
                    </div>

                </div>

                <div class="layui-row layui-col-space5 layui-form-item">

                    <div class="layui-col-xs4">
                        <label class="layui-form-label">
                            批准文号
                        </label>
                        <div class="layui-input-block">
                            <input type="text" name="approvalNo" lay-verify="" placeholder="请输入批准文号"
                                   autocomplete="off" class="layui-input">
                        </div>
                    </div>

                </div>

                <div class="block"></div>
                <div class="layui-row ">
                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <button class="layui-btn layui-btn-sm layui-btn-normal" lay-submit lay-filter="*">保存</button>
                            <button class="layui-btn layui-btn-sm layui-btn-primary form-reset" type="button">重置</button>
                            <button class="layui-btn layui-btn-sm layui-btn-primary form-close" type="button">关闭</button>
                        </div>
                    </div>
                </div>
            </form>


            <div class="layui-tab child-tab">
                <ul class="layui-tab-title">
                    <li class="layui-this">商品规格管理</li>
                </ul>
                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show">
                        <div id="materialSpecToolbar">
                            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" lay-event="addNewLine">
                                <i class="layui-icon layui-icon-add-1"></i> 增行
                            </button>
                            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" lay-event="batchSave">
                                <i class="layui-icon layui-icon-save"></i> 批量保存
                            </button>
                            <button type="button" class="layui-btn layui-btn-sm layui-btn-primary" lay-event="refresh">
                                <i class="layui-icon layui-icon-refresh"></i> 刷新
                            </button>
                        </div>
                        <div class="row-edit-table" id="material_spec_table" lay-filter="material_spec_table"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 子表管理模板 开始  -->
        <!-- 子表管理模板 开始  -->
        <script type="text/html" id="unitTpl">
            <select data-name="unit" value="{{d.unit ? d.unit : ''}}" placeholder="必填"
                    lay-filter="unit" lay-verify=""  data-index="{{d.LAY_TABLE_INDEX}}" lay-search>
                <option value="">请选择</option>
                {{# layui.each(packUnits, function(index, item){ }}
                <option value="{{item.name}}" {{item.name== d.unit ?
                'selected' : ''}}>{{item.name}}</option>
                {{# }) }}
            </select>
        </script>
        <script type="text/html" id="smallPackageUnitTpl">
            <select data-name="smallPackageUnit" value="{{d.smallPackageUnit ? d.smallPackageUnit : ''}}"
                    lay-filter="smallPackageUnit" data-index="{{d.LAY_TABLE_INDEX}}" lay-search>
                <option value="">请选择</option>
                {{# layui.each(packUnits, function(index, item){ }}
                <option value="{{item.id}}" {{item.name== d.smallPackageUnit ?
                'selected' : ''}}>{{item.name}}</option>
                {{# }) }}
            </select>
        </script>
        <script type="text/html" id="mediumPackageUnitTpl">

            <select data-name="mediumPackageUnit" value="{{d.mediumPackageUnit ? d.mediumPackageUnit : ''}}"
                    lay-filter="mediumPackageUnit" required data-index="{{d.LAY_TABLE_INDEX}}" lay-search>
                <option value="">请选择</option>
                {{# layui.each(packUnits, function(index, item){ }}
                <option value="{{item.id}}" {{item.name== d.mediumPackageUnit ?
                'selected' : ''}}>{{item.name}}</option>
                {{# }) }}
            </select>
        </script>
        <script type="text/html" id="largePackageUnitTpl">

            <select data-name="largePackageUnit" value="{{d.largePackageUnit ? d.largePackageUnit : ''}}"
                    lay-filter="largePackageUnit" data-index="{{d.LAY_TABLE_INDEX}}" lay-search>
                <option value="">请选择</option>
                {{# layui.each(packUnits, function(index, item){ }}
                <option value="{{item.id}}" {{item.name== d.largePackageUnit ?
                'selected' : ''}}>{{item.name}}</option>
                {{# }) }}
            </select>
        </script>
        <script type="text/html" id="materialSpecCellToolbar">
            {{#  if($strings.isBlank(d.id)){ }}
            <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="newEdit" title="保存"><i
                    class="fa fa-check"></i></a>
            <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="newDel" title="删除"><i
                    class="fa fa-trash-o"></i></a>
            {{#  } else { }}
            <a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="edit" title="保存"><i
                    class="fa fa-save"></i></a>
            <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del" title="删除"><i
                    class="fa fa-trash-o"></i></a>
            {{#  } }}
        </script>
        <!-- 子表管理模板 结束  -->

        <script src="/scripts/utils/common.js"></script>
        <script>

            let mainFunction = () => {
                let form = layui.form, $ = layui.$, dtree = layui.dtree, table = layui.table

                let model = {}


                window.packUnits = []

                $http.get("/base/pack_units/list").then(resp => {
                    window.packUnits = resp.data.data

                    $("[lay-filter$='PackageUnit']").empty()
                    $("[lay-filter$='PackageUnit']").append(`<option value=''>请选择</option>`)
                    packUnits.forEach(o => $("[lay-filter$='PackageUnit']").append(`<option value='${o.name}'>${o.name}</option>`))

                    $("[lay-filter$='unit']").empty()
                    $("[lay-filter$='unit']").append(`<option value=''>请选择</option>`)
                    packUnits.forEach(o => $("[lay-filter$='unit']").append(`<option value='${o.name}'>${o.name}</option>`))

                    renderPackUnit()
                })

                let renderPackUnit = (rows) => {
                    let data = rows ? rows : table.getRows("material_spec_table")

                    data.forEach((o, index) => {
                        $(`[lay-filter='unit'][data-index='${index}']`).val(o.unit)
                        $(`[lay-filter='smallPackageUnit'][data-index='${index}']`).val(o.smallPackageUnit)
                        $(`[lay-filter='mediumPackageUnit'][data-index='${index}']`).val(o.mediumPackageUnit)
                        $(`[lay-filter='largePackageUnit'][data-index='${index}']`).val(o.largePackageUnit)
                    })
                    form.render("select")
                }

                // 加载子表表格
                window.reloadMaterialSpecTable = () => {
                    if ($strings.isBlank(model.id)) {
                        return
                    }
                    $http.get(`/base/material_specs/list?materialId=${model.id}`).then(resp => {
                        layui.table.render({
                            elem: '#material_spec_table',
                            data: resp.data.data,
                            height: 400,
                            cols: [[
                                {type: 'numbers', align: 'center'},
                                {field: 'materialSpec', title: '规格', align: 'center', editConfig: { form: "input", verify: "required", placeholder: "必填" }},
                                {
                                    field: 'inputCodingType',
                                    title: '编码格式',
                                    align: 'center',
                                    editConfig: { form: "select", verify: "required", dict: "base_input_coding_type"}
                                },
                                {field: 'inputCode', title: '输入编码', align: 'center', editConfig: { form: "input", verify: "required", placeholder: "必填" }},
                                {field: 'form', title: '剂型', align: 'center', width: 80 ,editConfig: { form: "input", dict: "base_input_coding_type"}},
                                {field: 'unit', title: '单位', align: 'center', templet: "#unitTpl"},
                                {field: 'price', title: '价格', align: 'center', width: 80 , editConfig: { form: "input", verify: "required", placeholder: "必填" }},
                                {
                                    field: 'isConsignment',
                                    title: '寄售',
                                    align: 'center',
                                    editConfig: { form: "checkbox"},
                                    width: 60
                                },
                                {
                                    field: 'isOneThingOneYard',
                                    title: '一物一码',
                                    align: 'center',
                                    editConfig: { form: "checkbox" },
                                    width: 90
                                },
                                {
                                    field: 'smallPackageUnit',
                                    title: '小包装单位',
                                    align: 'center',
                                    templet: "#smallPackageUnitTpl"
                                },
                                {
                                    field: 'smallPackageQty',
                                    title: '小包装单位数量',
                                    align: 'center',
                                    editConfig: { form: "input", verify: "number", placeholder: "选填" },
                                    width: 80
                                },
                                {
                                    field: 'mediumPackageUnit',
                                    title: '中包装单位',
                                    align: 'center',
                                    templet: "#mediumPackageUnitTpl"
                                },
                                {
                                    field: 'mediumPackageQty',
                                    title: '中包装单位数量',
                                    align: 'center',
                                    editConfig: { form: "input", verify: "number", placeholder: "选填" },
                                    width: 80
                                },
                                {
                                    field: 'largePackageUnit',
                                    title: '大包装单位',
                                    align: 'center',
                                    templet: "#largePackageUnitTpl"
                                },
                                {
                                    field: 'largePackageQty',
                                    title: '大包装单位数量',
                                    align: 'center',
                                    editConfig: { form: "input", verify: "number", placeholder: "选填" },
                                    width: 80
                                },
                                {
                                    field: 'LAY_CELL_TOOLBAR',
                                    title: '操作',
                                    align: 'center',
                                    templet: "#materialSpecCellToolbar"
                                },
                            ]],
                            done(res) {
                                renderPackUnit(res.data)
                            }
                        });
                        $editable.watch('material_spec_table')
                    })
                }

                window.initForm = (formData) => {
                    // 必须要重新创建对象，原因未知
                    model = $.extend({}, formData)
                    $(".form-reset").click()
                    form.val("editForm", model)

                    if ($strings.isNotBlank(model.id)) {
                        $(".form-reset").hide()
                        $(".child-tab").show()
                        window.reloadMaterialSpecTable && window.reloadMaterialSpecTable()
                    } else {
                        $(".form-reset").show()
                        $(".child-tab").hide()
                    }
            }

            // 渲染商品品类
            dtree.renderOpenTree({
                title: "选择树",
                elem: "#catalogName",
                url: "/base/material_catalogs/tree",
                record: true,
                allowClear: true,
                allowFilter: true,
                filterMode: "pinyin",
                onClear() {
                    $("input[name='catalogId']").val("");
                    $("input[name='catalogName']").val("");
                },
                onConfirm(node) {

                    if (!node.leaf) {
                        layui.layer.msg("只能选择末级品类", {icon: 5})
                        return;
                    }

                    $("input[name='catalogId']").val(node.nodeId);
                    $("input[name='catalogName']").val(node.context);

                    let recordData = JSON.parse(node.recordData)
                    let materialTypeCode = recordData.properties.materialTypeCode
                    $("select[name='materialTypeCode']").val(materialTypeCode)
                    form.render('select')
                }
            })

            //渲染生产厂商
            layui.tableSelect.renderOpenTable({
                elem: '#manufacturerName',	//定义输入框input对象 必填
                title: "厂商选择",
                component: "/components/base/manufacturer_select.html",
                onConfirm(rows, elem) {
                    model.manufacturerId = rows.length > 0 ? rows[0].id : null
                    model.manufacturerName = rows.length > 0 ? rows[0].name : null
                    layui.each(rows, function (index, item) {
                        $("form input[name='manufacturerId']").val(model.manufacturerId)
                        $("form input[name='manufacturerName']").val(item.name)
                    })
                }
            })

            // 渲染下拉框 数据
            $global.getDictDataList('base_material_type').forEach(o => {
                $("select[name='materialTypeCode']").append("<option value='" + o.value + "'>" + o.label + "</option>")
            })

            // 渲染下拉框 数据
            form.render('select')

            // 渲染单选框/多选框 数据
            form.render('radio')

            // 渲染日期、时间 数据
            layui.laydate.render({
                elem: "input[name='certificateExpiredDate']",
                type: 'datetime',
                trigger: 'click'
            });


            /*** 子表管理开始 */
            $("#materialSpecToolbar button[lay-event='addNewLine']").click(() => {
                layui.table.addRow('material_spec_table', 0, {
                    inputCodingType: 0
                })

                form.render('select')
            })

            $("#materialSpecToolbar button[lay-event='batchSave']").click(() => {
                $editable.validateAllRows('material_spec_table', (valid, errors) => {
                    if (!valid) {
                        return
                    }
                    let rows = layui.table.getRows('material_spec_table')
                    if (rows.length == 0) {
                        return;
                    }
                    rows.forEach(o => {
                        o.materialId = model.id
                        o.isConsignment = $(`[data-name='isConsignment'][data-index='${o.LAY_TABLE_INDEX}']`)[0].checked ? "1" : "0"
                        o.isOneThingOneYard = $(`[data-name='isOneThingOneYard'][data-index='${o.LAY_TABLE_INDEX}']`)[0].checked ? "1" : "0"

                    })

                    $http.put("/base/material_specs/batch_save", rows).then(resp => {

                        if (resp.data.success) {
                            layui.layer.success(resp.data.msg)
                            window.reloadMaterialSpecTable()
                        } else {
                            layui.layer.error(resp.data.msg)
                        }
                    })
                })
            })

            $("#materialSpecToolbar button[lay-event='refresh']").click(() => {
                window.reloadMaterialSpecTable()
            })

            // 监听子表的列工具栏
            layui.table.on('tool(material_spec_table)', function (obj) {
                // 获取行索引
                let index = obj.tr[0].getAttribute("data-index")
                let data = obj.data;
                if (obj.event === 'newDel') {
                    // 未在数据库中存在，直接从界面移除即可
                    layui.table.deleteRow('material_spec_table', index)
                    return
                }
                if (obj.event === 'del') {
                    layer.confirm('真的删除行么', function (index) {
                        $http.delete(`/base/material_specs/` + data.id).then(resp => {
                            window.reloadMaterialSpecTable()
                            layer.success(resp.data.msg)
                        })
                    });
                    return
                }

                // 校验并保存
                $editable.validateSingleRow("material_spec_table", index, (valid, error) => {
                    if (!valid) {
                        return
                    }

                    let data = layui.table.cache.material_spec_table[index]
                    data.materialId = model.id
                    data.isConsignment = $(`[data-name='isConsignment'][data-index='${data.LAY_TABLE_INDEX}']`)[0].checked ? "1" : "0"
                    data.isOneThingOneYard = $(`[data-name='isOneThingOneYard'][data-index='${data.LAY_TABLE_INDEX}']`)[0].checked ? "1" : "0"

                    debugger
                    let promise = null
                    if ($strings.isBlank(data.id)) {
                        promise = $http.post("/base/material_specs/", data)
                    } else {
                        promise = $http.put("/base/material_specs/", data)
                    }

                    promise.then(resp => {
                        if (resp.data.success) {
                            layer.success(resp.data.msg)

                            // 重新渲染单行数据
                            layui.table.renderSpecRow('material_spec_table', index, {
                                id: resp.data.data.id
                            })
                        } else {
                            layer.error(resp.data.msg)
                        }
                    })
                })
            });


            /*** 子表管理结束 */

            $(".form-reset").click(() => {
                $("form")[0].reset()
                $("form input:hidden").val('')
            })
            $(".form-close").click(() => {
                var index = parent.layer.getFrameIndex(window.name);
                parent.layer.close(index);
            })

            // 监听表单提交事件
            form.on('submit(*)', (data) => {
                data.field = layui.$.extend({}, data.field)
                let promise = null
                if ($strings.isBlank(data.field.id)) {
                    promise = $http.post("/base/materials", data.field)
                } else {
                    promise = $http.put("/base/materials", data.field)
                }
                promise.then(resp => {
                    if (!resp.data.success) {
                        layer.error(resp.data.msg)
                        return
                    }
                    layer.success(resp.data.msg)

                    initForm($.extend(model, resp.data.data, {isNew: false}), false)
                    parent.reloadTable()
                })

                return false;
            });
            }

            extendParentScriptsAndStyles(() => {
                loadAllJs(["/scripts/utils/editable.js", "/lib/treeSelect.js", "/lib/tableSelect.js", "/lib/layui/lay.exts/dtree/dtree.js"], mainFunction)
            })

        </script>

    </body>
</html>
    
    